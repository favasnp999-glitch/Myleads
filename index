<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Lead Tracker CRM (Final Link Fix)</title>
    <style>
        :root {
            --primary: #007bff;
            --primary-dark: #0056b3;
            --success: #28a745;
            --info: #17a2b8;
            --warning: #ffc107;
            --danger: #dc3545;
            --light: #f8f9fa;
            --dark: #343a40;
            --border-color: #dee2e6;
            --bg-color: #f4f7f6;
            --card-bg: #fff;
            --font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            --mobile-padding: 8px;
            /* Height of the fixed dashboard (approx 50px) */
            --dashboard-height: 50px; 
        }
        * { box-sizing: border-box; margin:0; padding:0; }
        body {
            font-family: var(--font-family);
            background-color: var(--bg-color);
            line-height: 1.5;
            /* MODIFIED: Increased padding-bottom to clear the fixed dashboard */
            padding-bottom: calc(var(--dashboard-height) + 10px); 
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .container { padding: 0 var(--mobile-padding); max-width: 1200px; width:100%; margin:0 auto; }
        .search-filter-area { display:flex; flex-direction:column; gap:5px; padding:5px 0 10px 0; flex-shrink:0; }
        .search-row { display:flex; gap:5px; width:100%; }
        .search-box { flex-grow:1; padding:8px; border:1px solid var(--border-color); border-radius:6px; font-size:.9em; }
        .filter-select { padding:8px; border:1px solid var(--border-color); border-radius:6px; font-size:.9em; width:40%; min-width:100px; }
        .top-button { padding:8px 10px; border-radius:6px; border:none; cursor:pointer; font-size:.8em; font-weight:600; white-space:nowrap; flex-shrink:0; }
        .btn-primary { background-color:var(--primary); color:var(--light); }
        .btn-secondary { background-color:#6c757d; color:var(--light); }
        .btn-add-float { background-color:var(--primary); color:var(--light); font-size:1em; padding:8px 12px; height:38px; line-height:1; }
        
        /* Dashboard positioning fixed to the bottom */
        .dashboard-wrapper { 
            position:fixed; 
            bottom:0; /* Place right at the bottom */
            left:0; 
            width:100%; 
            padding: 0 var(--mobile-padding); 
            background-color: var(--card-bg); /* Use card-bg or bg-color for background */
            z-index: 10;
            box-shadow: 0 -2px 5px rgba(0,0,0,.05);
            height: var(--dashboard-height);
            display: flex;
            align-items: center; /* Vertically center the dashboard grid */
        }
        .dashboard { 
            display:grid; 
            grid-template-columns: repeat(5,1fr); 
            gap:4px; 
            padding:5px 0; 
            max-width: 1200px; 
            width: 100%;
            margin: 0 auto;
        }
        
        /* Dashboard card styles */
        .dashboard-card { 
            background:var(--card-bg); 
            border-radius:4px; 
            padding:2px 2px; 
            text-align:center; 
            box-shadow:0 1px 3px rgba(0,0,0,.05); 
            border-left:3px solid var(--primary); 
        }
        .dashboard-count { 
            font-size:1.1em; 
            font-weight:700; 
            line-height: 1.2;
        }
        .dashboard-label { 
            font-size:.6em; 
            color:#6c757d; 
            font-weight:500; 
            margin-top:0;
            line-height: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .tabs-nav { position:sticky; top:0; z-index:10; background-color:var(--card-bg); border-bottom:1px solid var(--border-color); overflow-x:scroll; white-space:nowrap; display:flex; box-shadow:0 1px 3px rgba(0,0,0,.1); flex-shrink:0; }
        .tab-button { display:inline-block; padding:8px 10px; text-decoration:none; color:var(--dark); background:none; border:none; cursor:pointer; font-size:.85em; font-weight:500; transition:color .2s, border-bottom .2s; flex-shrink:0; text-align:center; }
        .tab-button.active { color:var(--primary-dark); border-bottom:3px solid var(--primary); font-weight:600; }
        
        /* lead-list-wrapper takes all available space */
        .lead-list-wrapper { 
            flex-grow:1; 
            overflow-y:hidden; 
            padding-top:5px; 
        }
        .lead-list { display:flex; flex-direction:column; gap:6px; height:100%; overflow-y:auto; padding:0 var(--mobile-padding) 10px var(--mobile-padding); }
        
        .lead-card { background:var(--card-bg); border-radius:8px; padding:8px; box-shadow:0 1px 3px rgba(0,0,0,.08); display:grid; grid-template-columns:1fr auto; grid-template-rows:auto auto auto; gap:3px 10px; border-left:4px solid var(--primary); }
        .lead-card-name { font-weight:600; font-size:1em; grid-column:1 / 2; }
        .lead-detail { font-size:.8em; color:#495057; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
        .lead-detail span:first-child { font-weight:500; color:#6c757d; margin-right:3px; }
        .lead-actions { grid-column:2 / 3; grid-row:1 / 4; display:flex; flex-direction:column; gap:4px; align-items:flex-end; justify-content:center; }
        .lead-action-btn { padding:4px 7px; border-radius:4px; border:none; font-size:.7em; font-weight:600; }
        @media (min-width:768px) {
            .lead-card { grid-template-columns:2fr 1.5fr 1.5fr 1fr 1fr auto; grid-template-rows:auto; padding:10px; }
            .lead-detail span:first-child { display:none; }
            .lead-actions { grid-row:1 / 2; flex-direction:row; }
        }
        .status-New { border-left-color:var(--primary); }
        .status-Closed { border-left-color:var(--success); }
        .status-Not-Connected { border-left-color:var(--warning); }
        .status-Followup { border-left-color:var(--info); }
        .status-Rejected { border-left-color:var(--danger); }
        .modal { display:none; position:fixed; z-index:20; left:0; top:0; width:100%; height:100%; overflow:auto; background-color:rgba(0,0,0,.4); backdrop-filter: blur(2px); padding:var(--mobile-padding); }
        .modal-content { background-color:var(--card-bg); margin:10vh auto; padding:20px; border-radius:8px; width:100%; max-width:450px; box-shadow:0 4px 8px rgba(0,0,0,.2); position:relative; }
        .close-btn { color:#aaa; float:right; font-size:28px; font-weight:bold; line-height:1; cursor:pointer; position:absolute; top:10px; right:20px; transition:color .2s; }
        .close-btn:hover { color:#555; }
        .form-group { margin-bottom:12px; }
        .form-group label { display:block; margin-bottom:4px; font-weight:600; font-size:.9em; }
        .form-group input, .form-group select, .form-group textarea { width:100%; padding:8px; border:1px solid var(--border-color); border-radius:4px; font-size:.9em; }
        /* small table styles for user management list */
        #assignedUsersList .user-row { display:flex; justify-content:space-between; gap:8px; padding:6px 0; border-bottom:1px dashed #eee; align-items:center; }
        #assignedUsersList .user-row > span { flex:1; }
    </style>
</head>
<body>

    <div class="container">
        <div class="search-filter-area">
            <div class="search-row">
                <input type="text" id="searchBox" class="search-box" placeholder="Search Name/Mobile">
                <select id="assignedToFilter" class="filter-select">
                    <option value="All">All Users</option>
                </select>
            </div>
            <div style="display:flex; justify-content:space-between; gap:5px;">
                <div class="left-actions">
                    <button id="manageUsersBtn" class="top-button btn-secondary">Users</button>
                    <button id="exportExcelBtn" class="top-button btn-primary">Export</button>
                </div>
                <button id="addLeadFloatBtn" class="top-button btn-add-float">+ Add</button>
            </div>
        </div>
    </div>

    <div class="tabs-nav" id="tabsNav"></div>

    <div class="lead-list-wrapper">
        <div class="lead-list" id="leadList"></div>
    </div>

    <div class="dashboard-wrapper">
        <div class="dashboard" id="dashboard"></div>
    </div>


    <div id="addEditLeadModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" data-modal="addEditLeadModal">&times;</span>
            <h2 id="modalTitle">Add New Lead</h2>
            <form id="leadForm">
                <input type="hidden" id="leadId">
                <div class="form-group"><label for="leadName">Name</label><input type="text" id="leadName" required></div>
                <div class="form-group"><label for="leadMobile">Mobile Number</label><input type="text" id="leadMobile" required></div>
                <div class="form-group"><label for="leadAssignedTo">Assigned To</label><select id="leadAssignedTo" required></select></div>
                <div class="form-group"><label for="leadStatus">Status</label><select id="leadStatus" required></select></div>
                <div class="form-group"><label for="leadComment">Comment</label><textarea id="leadComment"></textarea></div>
                <div class="form-group"><label for="leadDate">Lead Date</label><input type="date" id="leadDate" required></div>
                <div class="modal-buttons" style="display:flex; justify-content:flex-end; gap:10px; margin-top:15px;">
                    <button type="button" class="top-button btn-secondary" onclick="closeModal('addEditLeadModal')">Cancel</button>
                    <button type="submit" class="top-button btn-primary">Save Lead</button>
                </div>
            </form>
        </div>
    </div>

    <div id="viewLeadModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" data-modal="viewLeadModal">&times;</span>
            <h2>Lead Details</h2>
            <div id="viewLeadDetails"></div>
            <div class="view-actions" style="display:flex; justify-content:space-around; margin:15px 0;">
                <a id="viewCallBtn" style="padding:8px 10px; border-radius:6px; font-weight:600; text-decoration:none; background-color:var(--success); color:white;" href="#" target="_blank">üìû Call</a>
                <a id="viewWhatsAppBtn" style="padding:8px 10px; border-radius:6px; font-weight:600; text-decoration:none; background-color:#25d366; color:white;" href="#" target="_blank">üì± WhatsApp</a>
                <button id="viewDeleteBtn" style="padding:8px 10px; border-radius:6px; font-weight:600; background-color:var(--danger); color:white;">üóëÔ∏è Delete Lead</button>
            </div>
        </div>
    </div>

    <div id="manageUsersModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" data-modal="manageUsersModal">&times;</span>
            <h2>Manage Assigned Users</h2>
            <form id="addUserForm" style="display:flex; gap:10px; margin-bottom:15px;">
                <input type="text" id="newUserName" placeholder="New User Name" required style="flex-grow:1; padding:8px;">
                <button type="submit" class="top-button btn-primary">Add</button>
            </form>
            <div id="assignedUsersList"></div>
        </div>
    </div>

    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>

    <script type="module">
        // -------------------------------
        // Firebase imports (modular)
        // -------------------------------
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
        import {
            getFirestore, collection, addDoc, setDoc, doc, getDocs, updateDoc, deleteDoc, query, where, orderBy
        } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";

        // -------------------------------
        // Your firebase config
        // -------------------------------
        const firebaseConfig = {
            apiKey: "AIzaSyBcMBLjda3ZbYxo-rsyzIBXoM2JilNtMaU",
            authDomain: "digic-organization.firebaseapp.com",
            projectId: "digic-organization",
            storageBucket: "digic-organization.firebasestorage.app",
            messagingSenderId: "142724095113",
            appId: "1:142724095113:web:8104e52bbed7598d3ffa58"
        };

        // initialize firebase app & firestore
        const fbApp = initializeApp(firebaseConfig);
        const db = getFirestore(fbApp);

        // -------------------------------
        // Constants & elements
        // -------------------------------
        // NOTE: The dashboard and filtering still primarily use the 'leads' collection.
        const LEAD_STATUSES = ['New', 'Closed', 'Not Connected', 'Followup', 'Rejected'];

        const elements = {
            dashboard: document.getElementById('dashboard'),
            tabsNav: document.getElementById('tabsNav'),
            leadList: document.getElementById('leadList'),
            searchBox: document.getElementById('searchBox'),
            assignedToFilter: document.getElementById('assignedToFilter'),
            addLeadFloatBtn: document.getElementById('addLeadFloatBtn'),
            manageUsersBtn: document.getElementById('manageUsersBtn'),
            exportExcelBtn: document.getElementById('exportExcelBtn'),
            addEditLeadModal: document.getElementById('addEditLeadModal'),
            viewLeadModal: document.getElementById('viewLeadModal'),
            manageUsersModal: document.getElementById('manageUsersModal'),
            leadForm: document.getElementById('leadForm'),
            leadId: document.getElementById('leadId'),
            leadName: document.getElementById('leadName'),
            leadMobile: document.getElementById('leadMobile'),
            leadAssignedTo: document.getElementById('leadAssignedTo'),
            leadStatus: document.getElementById('leadStatus'),
            leadComment: document.getElementById('leadComment'),
            leadDate: document.getElementById('leadDate'),
            viewLeadDetails: document.getElementById('viewLeadDetails'),
            viewCallBtn: document.getElementById('viewCallBtn'),
            viewWhatsAppBtn: document.getElementById('viewWhatsAppBtn'),
            viewDeleteBtn: document.getElementById('viewDeleteBtn'),
            addUserForm: document.getElementById('addUserForm'),
            newUserName: document.getElementById('newUserName'),
            assignedUsersList: document.getElementById('assignedUsersList'),
        };

        // -------------------------------
        // Helper -- modal close
        // -------------------------------
        const closeModal = (modalId) => {
            const m = document.getElementById(modalId);
            if (m) m.style.display = 'none';
        };
        window.closeModal = closeModal;

        // -------------------------------
        // Firestore wrappers for Users + Leads
        // Leads stored in "leads" (Active/History) and "closedLeads" (Archived copy)
        // -------------------------------
        const dbApi = {
            // Users (No change)
            addUser: async (name) => {
                const docRef = await addDoc(collection(db, "users"), { name: name.trim(), createdAt: new Date().toISOString() });
                return { id: docRef.id, name };
            },
            updateUser: async (id, data) => {
                await updateDoc(doc(db, "users", id), data);
            },
            deleteUser: async (id) => {
                await deleteDoc(doc(db, "users", id));
            },
            getAllUsers: async () => {
                const snap = await getDocs(collection(db, "users"));
                return snap.docs.map(d => ({ id: d.id, ...d.data() }));
            },

            // Leads (Active/History)
            addLead: async (leadData) => {
                await addDoc(collection(db, "leads"), leadData);
            },
            updateLead: async (id, leadData) => {
                await updateDoc(doc(db, "leads", id), leadData);
            },
            deleteLead: async (id) => {
                await deleteDoc(doc(db, "leads", id));
            },
            getAllLeads: async () => {
                const snap = await getDocs(collection(db, "leads"));
                return snap.docs.map(d => ({ id: d.id, ...d.data() }));
            },

            // Closed Leads (Archived Copy)
            // Use setDoc to copy the lead data, potentially keeping the same ID if desired, 
            // but for simple archiving, addDoc is usually easier to manage.
            addClosedLead: async (leadData) => {
                // Ensure the lead has an ID before copying the document data
                if (!leadData.id) return console.error("Cannot archive lead without an active ID.");
                
                // We will create a copy in the closedLeads collection, using the original lead's ID
                // to maintain a reference back to the original if necessary.
                const docRef = doc(db, "closedLeads", leadData.id);
                // We add the 'closedAt' timestamp to the archived copy
                await setDoc(docRef, { 
                    ...leadData,
                    closedAt: new Date().toISOString()
                });
            },
            getAllClosedLeads: async () => {
                const snap = await getDocs(collection(db, "closedLeads"));
                return snap.docs.map(d => ({ id: d.id, ...d.data() }));
            },
        };

        // -------------------------------
        // UI state
        // -------------------------------
        let currentFilterStatus = 'All';
        let currentFilterAssignedTo = 'All';
        let searchTerm = '';
        let usersCache = []; // {id, name}

        // -------------------------------
        // Utility: format date (e.g. "Dec 2025")
        // -------------------------------
        const formatDateToMY = (dateString) => {
            if (!dateString) return '';
            const date = new Date(dateString.replace(/-/g, '/'));
            return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short' });
        };

        // -------------------------------
        // Populate dropdowns / UI pieces
        // -------------------------------
        const populateAssignedUsersDropdowns = async () => {
            usersCache = await dbApi.getAllUsers();
            // leadAssignedTo (for form)
            elements.leadAssignedTo.innerHTML = '';
            usersCache.forEach(u => {
                const o = document.createElement('option');
                o.value = u.id;
                o.textContent = u.name;
                elements.leadAssignedTo.appendChild(o);
            });

            // assignedToFilter
            elements.assignedToFilter.innerHTML = '<option value="All">All Users</option>';
            usersCache.forEach(u => {
                const o = document.createElement('option');
                o.value = u.id;
                o.textContent = u.name;
                elements.assignedToFilter.appendChild(o);
            });
            elements.assignedToFilter.value = currentFilterAssignedTo;
        };

        const populateStatusDropdown = () => {
            elements.leadStatus.innerHTML = '';
            LEAD_STATUSES.forEach(s => {
                const o = document.createElement('option');
                o.value = s;
                o.textContent = s;
                elements.leadStatus.appendChild(o);
            });
        };

        // -------------------------------
        // Render Tabs
        // -------------------------------
        const renderTabs = () => {
            elements.tabsNav.innerHTML = '';
            // NOTE: 'Closed' leads are handled by the main 'leads' collection
            const statuses = ['All', ...LEAD_STATUSES]; 
            
            statuses.forEach(status => {
                const btn = document.createElement('button');
                btn.className = `tab-button ${status === currentFilterStatus ? 'active' : ''}`;
                btn.textContent = status;
                btn.dataset.status = status;
                btn.addEventListener('click', () => {
                    currentFilterStatus = status;
                    renderTabs();
                    filterAndRenderLeads();
                });
                elements.tabsNav.appendChild(btn);
            });
        };

        // -------------------------------
        // Filter + Render Leads
        // -------------------------------
        const filterAndRenderLeads = async () => {
            let allLeads = await dbApi.getAllLeads();
            let filtered = allLeads;

            // Filtering based on currentFilterStatus
            if (currentFilterStatus !== 'All') {
                filtered = filtered.filter(l => l.status === currentFilterStatus);
            }
            
            // Filtering based on currentFilterAssignedTo
            if (currentFilterAssignedTo !== 'All') {
                filtered = filtered.filter(l => l.assignedToUserId === currentFilterAssignedTo);
            }

            // Filtering based on searchTerm
            if (searchTerm) {
                const s = searchTerm.toLowerCase();
                filtered = filtered.filter(l => (l.name && l.name.toLowerCase().includes(s)) || (l.mobile && l.mobile.includes(s)));
            }

            elements.leadList.innerHTML = '';
            if (filtered.length === 0) {
                elements.leadList.innerHTML = `<p style="text-align:center; padding:20px;">No leads match the current filters.</p>`;
                updateDashboard();
                return;
            }

            // map user ids to names for display
            const userMap = Object.fromEntries(usersCache.map(u => [u.id, u.name]));

            filtered.forEach(lead => {
                const card = document.createElement('div');
                const statusClass = `status-${(lead.status || 'New').replace(/\s/g, '-')}`;
                card.className = `lead-card ${statusClass}`;

                const createdDateMY = lead.leadDate ? formatDateToMY(lead.leadDate) : '';

                const assignedName = lead.assignedToUserId ? (userMap[lead.assignedToUserId] || '--') : (lead.assignedTo || '--');
                
                // Leads displayed here are always from the 'leads' collection
                const collection = 'leads'; 

                card.innerHTML = `
                    <div class="lead-card-name">${lead.name || '--'}</div>
                    <div class="lead-detail lead-detail-mobile"><span>Mobile:</span> ${lead.mobile || '--'}</div>
                    <div class="lead-detail lead-detail-assigned"><span>Assigned:</span> ${assignedName}</div>
                    <div class="lead-detail lead-detail-status"><span>Status:</span> ${lead.status || 'New'}</div>
                    <div class="lead-detail lead-detail-created"><span>Created:</span> ${createdDateMY}</div>
                    <div class="lead-actions">
                        <button class="lead-action-btn btn-view" data-id="${lead.id}" data-collection="${collection}">View</button>
                        <button class="lead-action-btn btn-edit" data-id="${lead.id}" data-collection="${collection}">Edit</button>
                    </div>
                `;
                elements.leadList.appendChild(card);
            });

            elements.leadList.querySelectorAll('.btn-view').forEach(btn => btn.addEventListener('click', (e) => openViewLeadModal(e.target.dataset.id, e.target.dataset.collection)));
            elements.leadList.querySelectorAll('.btn-edit').forEach(btn => btn.addEventListener('click', (e) => openAddEditLeadModal(e.target.dataset.id)));

            updateDashboard();
        };

        // -------------------------------
        // Dashboard counts
        // -------------------------------
        const updateDashboard = async () => {
            // Dashboard calculates all leads in the active 'leads' collection
            const allLeads = await dbApi.getAllLeads();
            elements.dashboard.innerHTML = '';
            
            LEAD_STATUSES.forEach(status => {
                const count = allLeads.filter(l => l.status === status).length;
                const c = document.createElement('div');
                c.className = 'dashboard-card';
                c.innerHTML = `<div class="dashboard-count">${count}</div><div class="dashboard-label">${status.toUpperCase()}</div>`;
                elements.dashboard.appendChild(c);
            });
        };

        // -------------------------------
        // Open Add/Edit Lead Modal
        // -------------------------------
        const openAddEditLeadModal = async (id = null) => {
            await populateAssignedUsersDropdowns();
            populateStatusDropdown();

            elements.leadForm.reset();
            elements.leadId.value = '';

            if (id) {
                document.getElementById('modalTitle').textContent = 'Edit Lead';
                // Look up lead in the active collection for editing
                const all = await dbApi.getAllLeads(); 
                const lead = all.find(l => l.id === id);
                if (lead) {
                    elements.leadId.value = lead.id;
                    elements.leadName.value = lead.name || '';
                    elements.leadMobile.value = lead.mobile || '';
                    elements.leadAssignedTo.value = lead.assignedToUserId || '';
                    elements.leadStatus.value = lead.status || LEAD_STATUSES[0];
                    elements.leadComment.value = lead.comment || '';
                    elements.leadDate.value = lead.leadDate || new Date().toISOString().split('T')[0];
                } else {
                     alert("Lead not found.");
                     return;
                }
            } else {
                document.getElementById('modalTitle').textContent = 'Add New Lead';
                elements.leadDate.value = new Date().toISOString().split('T')[0];
            }

            elements.addEditLeadModal.style.display = 'block';
        };

        // -------------------------------
        // Open View Lead Modal
        // -------------------------------
        const openViewLeadModal = async (id, collection) => {
            let lead;
            
            // Fetch lead from the correct collection based on where the button was clicked
            if (collection === 'closedLeads') {
                const snap = await getDoc(doc(db, "closedLeads", id));
                if (snap.exists()) lead = { id: snap.id, ...snap.data() };
            } else { // 'leads'
                const all = await dbApi.getAllLeads();
                lead = all.find(l => l.id === id);
            }
            
            if (!lead) return;

            // resolve assigned user name
            const user = usersCache.find(u => u.id === lead.assignedToUserId);
            const assignedName = user ? user.name : (lead.assignedTo || '--');
            
            elements.viewLeadDetails.innerHTML = `
                <div style="padding:5px 0;"><strong>Name:</strong> ${lead.name || '--'}</div>
                <div style="padding:5px 0;"><strong>Mobile:</strong> ${lead.mobile || '--'}</div>
                <div style="padding:5px 0;"><strong>Assigned To:</strong> ${assignedName}</div>
                <div style="padding:5px 0;"><strong>Status:</strong> ${lead.status || '--'}</div>
                <div style="padding:5px 0;"><strong>Created:</strong> ${lead.leadDate || '--'} (${formatDateToMY(lead.leadDate)})</div>
                ${lead.closedAt ? `<div style="padding:5px 0;"><strong>Archived:</strong> ${new Date(lead.closedAt).toLocaleDateString()}</div>` : ''}
                <div style="padding:5px 0;"><strong>Comment:</strong> ${lead.comment || 'N/A'}</div>
            `;

            const mobileNumber = (lead.mobile || '').toString().trim();
            elements.viewCallBtn.href = `tel:${mobileNumber}`;
            const isIndianMobile = mobileNumber.length === 10 && mobileNumber.match(/^[6-9]\d{9}$/);
            const wa = isIndianMobile ? `91${mobileNumber}` : mobileNumber;
            elements.viewWhatsAppBtn.href = `https://wa.me/${wa}`;

            elements.viewDeleteBtn.onclick = async () => {
                if (confirm(`Delete lead "${lead.name}" permanently from the ${collection} table?`)) {
                    try {
                        if (collection === 'closedLeads') {
                            await deleteDoc(doc(db, "closedLeads", lead.id));
                        } else {
                            // If deleting from 'leads', we should also check if an archived copy exists and prompt to delete that too if desired.
                            await dbApi.deleteLead(lead.id); 
                        }
                        alert('Lead deleted successfully');
                        closeModal('viewLeadModal');
                        await refreshAll();
                    } catch (err) {
                        console.error(err);
                        alert('Error deleting lead');
                    }
                }
            };

            elements.viewLeadModal.style.display = 'block';
        };

        // -------------------------------
        // Handle Lead Form Submit (CRITICAL CHANGE)
        // -------------------------------
        const handleLeadFormSubmit = async (e) => {
            e.preventDefault();
            const newStatus = elements.leadStatus.value;
            const id = elements.leadId.value;
            
            const leadData = {
                name: elements.leadName.value.trim(),
                mobile: elements.leadMobile.value.trim(),
                assignedToUserId: elements.leadAssignedTo.value || null,
                status: newStatus,
                comment: elements.leadComment.value.trim(),
                leadDate: elements.leadDate.value,
                updatedAt: new Date().toISOString()
            };

            try {
                if (id) {
                    // --- EDIT EXISTING LEAD ---
                    
                    // 1. Update in the active leads collection (ALWAYS do this first)
                    await dbApi.updateLead(id, leadData);
                    
                    if (newStatus === 'Closed') {
                        // 2. If the new status is 'Closed', copy the *updated* data (including its ID) 
                        // to the archival collection, which will include a 'closedAt' timestamp.
                        // We fetch the latest data including the created/updated timestamps if possible
                        // However, since we updated it just above, we pass the current data with the ID.
                        await dbApi.addClosedLead({ id, ...leadData }); 
                        alert('Lead updated and archived successfully');
                    } else {
                        // 3. If status is NOT closed, just an update happens above (step 1).
                        alert('Lead updated successfully');
                    }
                } else {
                    // --- ADD NEW LEAD ---
                    leadData.createdAt = new Date().toISOString();
                    await dbApi.addLead(leadData);
                    alert('Lead added successfully');
                    
                    // NOTE: If status is 'Closed' upon creation, it will be added to `leads` 
                    // and then the next update or manual trigger would archive it. 
                    // For simplicity, we only trigger archiving on updates *to* 'Closed' status.
                }
                closeModal('addEditLeadModal');
                await refreshAll();
            } catch (err) {
                console.error(err);
                alert('Error saving lead. Check console.');
            }
        };

        // -------------------------------
        // User Management UI (No change needed)
        // -------------------------------
        const renderAssignedUsersList = async () => {
            usersCache = await dbApi.getAllUsers();
            elements.assignedUsersList.innerHTML = '';
            usersCache.forEach(u => {
                const div = document.createElement('div');
                div.className = 'user-row';
                div.innerHTML = `<span>${u.name}</span>
                    <div style="display:flex; gap:8px;">
                        <button class="top-button btn-primary btn-edit-user" data-id="${u.id}" data-name="${u.name}">Edit</button>
                        <button class="top-button btn-secondary btn-delete-user" data-id="${u.id}" style="background-color:var(--danger); color:white;">Delete</button>
                    </div>`;
                elements.assignedUsersList.appendChild(div);
            });

            elements.assignedUsersList.querySelectorAll('.btn-delete-user').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const id = e.target.dataset.id;
                    const name = usersCache.find(x => x.id === id)?.name || 'user';
                    if (confirm(`Delete user "${name}"? This does NOT delete leads assigned to them.`)) {
                        try {
                            await dbApi.deleteUser(id);
                            await populateAssignedUsersDropdowns();
                            await refreshAll();
                        } catch (err) {
                            console.error(err);
                            alert('Error deleting user. Check console.');
                        }
                    }
                });
            });

            elements.assignedUsersList.querySelectorAll('.btn-edit-user').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const id = e.target.dataset.id;
                    const currentName = e.target.dataset.name;
                    const newName = prompt('Edit user name:', currentName);
                    if (newName && newName.trim() !== '') {
                        try {
                            await dbApi.updateUser(id, { name: newName.trim() });
                            await populateAssignedUsersDropdowns();
                            await refreshAll();
                        } catch (err) {
                            console.error(err);
                            alert('Error updating user');
                        }
                    }
                });
            });
        };

        const handleAddUserFormSubmit = async (e) => {
            e.preventDefault();
            const newName = elements.newUserName.value.trim();
            if (!newName) return;
            try {
                await dbApi.addUser(newName);
                elements.newUserName.value = '';
                await renderAssignedUsersList();
                await populateAssignedUsersDropdowns();
            } catch (err) {
                console.error(err);
                alert('Error adding user');
            }
        };

        // -------------------------------
        // Export to Excel (Updated to include closed leads)
        // -------------------------------
        const exportToExcel = async () => {
            const allActiveLeads = await dbApi.getAllLeads();
            const allClosedLeads = await dbApi.getAllClosedLeads();
            const allLeads = [...allActiveLeads.map(l => ({ ...l, Archived: 'No' })), ...allClosedLeads.map(l => ({ ...l, Archived: 'Yes'}))];
            
            if (allLeads.length === 0) { alert('No leads to export.'); return; }
            
            // map assignedToUserId -> name
            const userMap = Object.fromEntries(usersCache.map(u => [u.id, u.name]));
            const exportData = allLeads.map(l => ({
                ID: l.id,
                Name: l.name,
                'Mobile Number': l.mobile,
                'Assigned To': l.assignedToUserId ? (userMap[l.assignedToUserId] || l.assignedToUserId) : (l.assignedTo || ''),
                Status: l.status,
                Comment: l.comment,
                'Lead Date': l.leadDate,
                'Is Archived (Closed)': l.Archived,
                'Closed/Archived Timestamp': l.closedAt || '',
            }));
            const worksheet = XLSX.utils.json_to_sheet(exportData);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "All_Leads");
            XLSX.writeFile(workbook, "Lead_Tracker_Export_All.xlsx");
            alert('All leads (Active + Archived) exported successfully!');
        };

        // -------------------------------
        // Refresh all UI
        // -------------------------------
        const refreshAll = async () => {
            await populateAssignedUsersDropdowns();
            renderTabs();
            // Re-render leads list based on current filters (which uses the 'leads' table)
            await filterAndRenderLeads(); 
            await renderAssignedUsersList();
            await updateDashboard();
        };

        // -------------------------------
        // Event listeners and init
        // -------------------------------
        const setupEventListeners = () => {
            document.querySelectorAll('.close-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const modalId = e.target.getAttribute('data-modal');
                    if (modalId) closeModal(modalId);
                });
            });

            // Close modals when clicking outside
            window.addEventListener('click', (e) => {
                if (e.target.classList.contains('modal')) closeModal(e.target.id);
            });

            elements.searchBox.addEventListener('input', () => {
                searchTerm = elements.searchBox.value.trim();
                filterAndRenderLeads();
            });

            elements.assignedToFilter.addEventListener('change', (e) => {
                currentFilterAssignedTo = e.target.value;
                filterAndRenderLeads();
            });

            elements.addLeadFloatBtn.addEventListener('click', () => openAddEditLeadModal());
            elements.leadForm.addEventListener('submit', handleLeadFormSubmit);

            elements.manageUsersBtn.addEventListener('click', async () => {
                await renderAssignedUsersList();
                elements.manageUsersModal.style.display = 'block';
            });
            elements.addUserForm.addEventListener('submit', handleAddUserFormSubmit);

            elements.exportExcelBtn.addEventListener('click', exportToExcel);
        };

        // -------------------------------
        // Initializer (UI init)
        // -------------------------------
        const initUI = async () => {
            setupEventListeners();
            await refreshAll();
        };

        // run on DOM ready
        document.addEventListener('DOMContentLoaded', () => {
            initUI().catch(err => console.error('Init error', err));
        });

    </script>
</body>
</html>
